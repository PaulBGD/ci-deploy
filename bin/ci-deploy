#!/usr/bin/env node

var fs = require('fs');
var net = require('net');
var path = require('path');
var glob = require('glob');
var yaml = require('js-yaml');
var crypto = require('crypto');
var archiver = require('archiver');

process.argv.splice(0, 2);

var configFile = path.join(process.env.HOME || process.env.USERPROFILE, 'config.json');

if (process.argv.length == 1 && process.argv[0].toLowerCase() === 'configure') {
    if (fs.existsSync(configFile)) {
        var data = fs.readFileSync(configFile, 'utf8').toString();
        var json = JSON.parse(data);
        if (json.key) {
            return console.log('Your key is ' + json.key + '. Configuration located at ' + configFile);
        }
    }
    var bytes = crypto.randomBytes(48);
    var string = bytes.toString('hex');
    fs.writeFileSync(configFile, JSON.stringify({key: string, ip: '127.0.0.1', port: 8084}, null, 3));
    console.log('Your key is ' + string + '. Configuration located at ' + configFile);
} else if (process.argv.length == 1 && process.argv[0].toLowerCase() == 'test') {
    var config = require(configFile);
    var client = new net.Socket();
    client.connect(config.port, config.ip, function () {
        console.log('Connected to server');
        client.end();
    });
} else if (process.argv.length == 1) {
    // deploy
    var split = process.argv[0].split('/');
    var id = split.slice(split.length - 2, split.length).join('/').replace('.git', '');
    console.log('Id: ' + id);
    var gitlabYML = path.join(process.cwd(), '.ci-deploy.yml');
    if (!fs.existsSync(gitlabYML)) {
        return console.error('.ci-deploy.yml does not exist!');
    }
    data = yaml.load(fs.readFileSync(gitlabYML));
    if (!data['ci-deploy']) {
        return console.error('ci-deploy not found');
    }
    var toGlob = data['ci-deploy'].files || [];
    var files = [];
    toGlob.forEach(function (toGlob) {
        files = files.concat(glob.sync(toGlob));
    });
    if (files.length == 1) {
        // upload a single file
        upload(fs.createReadStream(files[0]), path.extname(files[0]), id);
    } else if (files.length > 1) {
        // zip the files
        var zip = archiver('zip', {});
        files.forEach(function (file) {
            zip.file(file, {name: file});
        });
        zip.finalize();
        zip.on('finish', function () {
            upload(zip, '.zip', id);
        });
    } else {
        throw new Error('No files to upload!');
    }
} else {
    throw new Error('Invalid usage. Usage: ci-deploy [configure|$CI_PROJECT_ID]');
}

function upload(pipe, extension, projectId) {
    if (!fs.existsSync(configFile)) {
        throw new Error('Key does not exist! Have you ran ci-deploy configure? I\'m looking at ' + configFile);
    }
    var config = require(configFile);
    if (!config.key) {
        throw new Error('Key does not exist! Have you ran ci-deploy configure? I\'m looking at ' + configFile);
    }
    var buffers = [];
    pipe.on('data', function (buffer) {
        buffers.push(buffer);
    });
    pipe.on('end', function () {
        var buffer = Buffer.concat(buffers);
        var key = config.key;
        var id = key.substring(0, key.length / 2);
        var salt = key.substring(key.length / 2, key.length);
        var cipher = crypto.createCipher('aes-256-cbc', salt, salt);
        cipher.setAutoPadding(false);
        buffer = cipher.update(buffer);

        // buffer is encrypted, time to send
        var client = new net.Socket();
        client.connect(config.port, config.ip, function () {
            var closed = false;
            console.log('Connected to server');

            console.log('Sending unique id..');
            client.write(id, sendProjectId);

            function sendProjectId() {
                console.log('Sending project id..');
                client.write(projectId, sendExtension);
            }

            function sendExtension() {
                console.log('Sending extension..');
                client.write(extension, sendFile);
            }

            function sendFile() {
                console.log('Sending file..');
                client.write(buffer.toString('base64'), finish);
            }

            function finish() {
                var interval = setInterval(function () {
                    if (closed) {
                        return clearInterval(interval);
                    }
                    console.log('Sending end code..');
                    client.write('done');
                }, 1000);
            }

            client.on('close', function () {
                closed = true;
            });
        });
    });
}
